import{u as rt,a as Vt,g as w,b as $,c as ue,r as Ot,s as ut,d as mt,e as Yt,i as _t,f as jt,h as Kt}from"./api.js";let c=null,Q=null,b=null,V=null;const r=document.getElementById("dial-grid"),y=document.getElementById("groups-container"),B=document.getElementById("custom-context-menu"),Xt=document.getElementById("ctx-sort-name-asc"),Zt=document.getElementById("ctx-sort-name-desc"),Qt=document.getElementById("ctx-sort-date-asc"),Jt=document.getElementById("ctx-sort-date-desc"),me=document.getElementById("modal"),tt=document.getElementById("modal-title"),en=document.getElementById("add-btn"),tn=document.getElementById("close-modal"),nn=document.getElementById("cancel-btn"),Ze=document.getElementById("dial-form"),gt=document.getElementById("dial-title"),pt=document.getElementById("dial-url"),J=document.getElementById("group-modal"),vt=document.getElementById("group-modal-title"),A=document.getElementById("scroll-up-btn"),H=document.getElementById("scroll-down-btn"),on=document.getElementById("add-group-btn"),an=document.getElementById("close-group-modal"),dn=document.getElementById("cancel-group-btn"),Qe=document.getElementById("group-form"),Pe=document.getElementById("group-title"),ge=document.getElementById("advanced-group-modal"),sn=document.getElementById("advanced-group-modal-title"),ht=document.getElementById("adv-group-title-input"),ln=document.getElementById("close-advanced-group-modal"),cn=document.getElementById("adv-group-save-btn"),rn=document.getElementById("adv-group-discard-btn"),pe=document.querySelectorAll(".adv-sidebar-btn"),yt=document.querySelectorAll(".adv-tab-content"),ee=document.getElementById("adv-group-cols-val"),nt=document.getElementById("adv-group-cols-up"),ot=document.getElementById("adv-group-cols-down"),te=document.getElementById("adv-group-rows-val"),at=document.getElementById("adv-group-rows-up"),dt=document.getElementById("adv-group-rows-down"),ve=document.getElementById("adv-layout-dynamic"),he=document.getElementById("adv-layout-list"),ye=document.getElementById("adv-layout-grid"),un=document.getElementById("adv-dyn-w-up"),mn=document.getElementById("adv-dyn-w-down"),Ne=document.getElementById("adv-dyn-w-val"),gn=document.getElementById("adv-dyn-h-up"),pn=document.getElementById("adv-dyn-h-down"),Ue=document.getElementById("adv-dyn-h-val"),st=document.getElementById("add-group-tab-btn");st&&st.addEventListener("click",e=>{e.stopPropagation(),b=null,vt.textContent="A√±adir Nuevo Grupo",Pe.value="",J.classList.remove("hidden"),setTimeout(()=>Pe.focus(),50)});const vn=document.getElementById("adv-list-w-up"),hn=document.getElementById("adv-list-w-down"),We=document.getElementById("adv-list-w-val"),ft=document.getElementById("adv-list-dir-h"),Et=document.getElementById("adv-list-dir-v"),Y=document.getElementById("adv-grid-fill"),_=document.getElementById("adv-grid-center"),yn=document.getElementById("adv-grid-aw-up"),fn=document.getElementById("adv-grid-aw-down"),Fe=document.getElementById("adv-grid-aw-val"),En=document.getElementById("adv-grid-ah-up"),Ln=document.getElementById("adv-grid-ah-down"),ze=document.getElementById("adv-grid-ah-val"),ie=document.querySelectorAll(".adv-icon-choice"),T=document.getElementById("adv-text-color-enable"),W=document.getElementById("adv-text-color-hex"),I=document.getElementById("adv-text-color-picker"),Lt=document.querySelectorAll('input[name="bg"]'),$e=document.getElementById("adv-bg-solid-body"),P=document.getElementById("adv-bg-solid-color"),qe=document.getElementById("adv-bg-solid-hex"),Ae=document.getElementById("adv-bg-gradient-body"),bt=document.querySelectorAll('input[name="grad"]'),N=document.getElementById("adv-bg-grad-color1"),Re=document.getElementById("adv-bg-grad-hex1"),U=document.getElementById("adv-bg-grad-color2"),Ve=document.getElementById("adv-bg-grad-hex2"),D=document.getElementById("adv-gap-enable"),k=document.getElementById("adv-gap-range"),ce=document.getElementById("adv-gap-val"),j=document.getElementById("adv-open-window"),K=document.getElementById("adv-open-tab"),X=document.getElementById("adv-set-default"),S=document.getElementById("adv-is-locked"),F=document.getElementById("adv-password-container"),M=document.getElementById("adv-group-password"),fe=document.getElementById("advanced-modal-content"),Z=document.getElementById("advanced-modal-drag-handle");let Je=!1,Bt=0,It=0,Ee=0,Le=0;Z&&fe&&Z.addEventListener("mousedown",e=>{Je=!0,Z.style.cursor="grabbing",Bt=e.clientX-Ee,It=e.clientY-Le,document.addEventListener("mousemove",wt),document.addEventListener("mouseup",xt)});function wt(e){Je&&(Ee=e.clientX-Bt,Le=e.clientY-It,fe.style.transform=`translate(${Ee}px, ${Le}px)`)}function xt(){Je=!1,Z&&(Z.style.cursor="grab"),document.removeEventListener("mousemove",wt),document.removeEventListener("mouseup",xt)}const be=document.getElementById("stats-modal"),bn=document.getElementById("close-stats-modal"),Bn=document.getElementById("stats-total-groups"),In=document.getElementById("stats-total-dials"),wn=document.getElementById("stats-avg-dials"),Be=document.getElementById("errors-modal"),xn=document.getElementById("close-errors-modal"),kn=document.getElementById("errors-log-area"),Cn=document.getElementById("clear-errors-btn"),q=document.getElementById("search-modal"),Sn=document.getElementById("close-search-modal"),Oe=document.getElementById("search-dial-input"),re=document.getElementById("search-results-container"),R=document.getElementById("share-bottom-bar"),Tn=document.getElementById("share-bottom-select-all-btn"),Dn=document.getElementById("share-bottom-count"),Mn=document.getElementById("share-bottom-cancel-btn"),Gn=document.getElementById("share-bottom-up-btn"),ne=document.getElementById("share-modal-advanced"),$n=document.getElementById("close-advanced-share-modal"),An=document.getElementById("btn-back-to-selection"),Hn=document.getElementById("share-modal-count-text"),Pn=document.getElementById("share-modal-subtitle-text"),le=document.getElementById("share-selected-list"),kt=document.getElementById("share-title-input"),Nn=document.getElementById("share-advanced-copy-btn"),Un=document.getElementById("share-advanced-export-btn");let G=!1,m=new Set;const Ye=document.getElementById("settings-sidebar"),Ct=document.getElementById("settings-btn"),E=document.getElementById("dropdown-menu"),Wn=document.getElementById("close-settings"),O=document.getElementById("toggle-edit-mode"),St=document.getElementById("settings-import-native-btn"),Fn=document.getElementById("settings-import-html-btn"),Tt=document.getElementById("settings-import-html-input"),Ie=document.getElementById("onboarding-modal"),Dt=document.getElementById("onboarding-native-btn"),zn=document.getElementById("onboarding-html-btn"),Mt=document.getElementById("onboarding-html-input"),qn=document.getElementById("skip-onboarding-btn"),Gt=["linear-gradient(135deg, #3b82f6, #8b5cf6)","linear-gradient(135deg, #10b981, #3b82f6)","linear-gradient(135deg, #f59e0b, #ef4444)","linear-gradient(135deg, #ec4899, #8b5cf6)","linear-gradient(135deg, #06b6d4, #3b82f6)"];function Rn(e){let t=0;for(let o=0;o<e.length;o++)t=e.charCodeAt(o)+((t<<5)-t);return Math.abs(t)%Gt.length}function Vn(e,t){if(e)return e.charAt(0).toUpperCase();try{return new URL(t).hostname.replace("www.","").charAt(0).toUpperCase()}catch{return"?"}}async function On(){const e=await w(),t=await ue(e[0]?.id||"");if(e.length===1&&e[0].title==="Inicio"&&t.length===0&&Ie.classList.remove("hidden"),e.length>0){const o=e.find(n=>n.isDefault);o?c=o.id:c=e[0].id}await C(),c&&await f()}function _e(){!A||!H||!y||(y.scrollHeight>y.clientHeight?(y.scrollTop>0?A.classList.remove("hidden"):A.classList.add("hidden"),Math.ceil(y.scrollTop+y.clientHeight)>=y.scrollHeight?H.classList.add("hidden"):H.classList.remove("hidden")):(A.classList.add("hidden"),H.classList.add("hidden")))}async function C(){const e=await w();y.innerHTML="",e.length>0&&!c&&(c=e[0].id);for(const t of e){const o=document.createElement("div"),n=await ue(t.id);let d=!1;G&&n.length>0&&(d=n.every(u=>m.has(u.id))),o.className=`group-tab ${t.id===c?"active":""} ${d?"is-share-selected":""}`;const s=t.textColor?`style="color: ${t.textColor} !important;"`:"";let i=t.groupIcon?`<span style="margin-right: 6px; font-size: 1.1rem; line-height: 1;">${t.groupIcon}</span>`:"";t.isLocked&&(i+='<svg style="margin-right: 4px; width: 14px; height: 14px; opacity: 0.7;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>'),t.isDefault&&(i+='<svg style="margin-right: 4px; width: 14px; height: 14px; opacity: 0.5;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>'),o.innerHTML=`
      <div class="group-share-check">
         <svg viewBox="0 0 24 24" fill="none" class="icon" stroke="currentColor" stroke-width="3" style="width:10px; height:10px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
      </div>
      <span class="group-icon-container">${i}</span>
      <span class="group-title" ${s}>${t.title.replace(/^[üìÅüìÇ]\s*/,"").trim()||t.title}</span>
      <div class="group-tab-actions">
        <button class="btn-icon-small edit-group-btn" data-id="${t.id}" title="Editar Grupo">‚úèÔ∏è</button>
        ${e.length>1?`<button class="btn-icon-small delete-group-btn" data-id="${t.id}" title="Eliminar Grupo">‚úñ</button>`:""}
      </div>
    `,o.addEventListener("click",async u=>{if(G){u.preventDefault(),u.stopPropagation(),n.length>0&&n.every(h=>m.has(h.id))?(n.forEach(h=>m.delete(h.id)),o.classList.remove("is-share-selected")):(n.forEach(h=>m.add(h.id)),o.classList.add("is-share-selected")),Se(),c===t.id&&f();return}if(!u.target.closest(".group-tab-actions")){if(t.isLocked&&c!==t.id){const L=prompt("Este grupo est√° bloqueado. Introduce la contrase√±a para acceder:"),h=t.password||"0000";if(L!==h)return}c=t.id,await C(),await f()}}),o.querySelector(".edit-group-btn")?.addEventListener("click",u=>{if(u.stopPropagation(),t.isLocked){const L=prompt("Introduce la contrase√±a para editar este grupo bloqueado:"),h=t.password||"0000";if(L!==h)return}At(t)}),o.querySelector(".delete-group-btn")?.addEventListener("click",async u=>{if(u.stopPropagation(),t.isLocked){const L=prompt("Introduce la contrase√±a para eliminar este grupo bloqueado:"),h=t.password||"0000";if(L!==h)return}if(e.length===1){alert("No puedes eliminar el √∫nico grupo que existe.");return}confirm(`¬øEst√°s seguro de eliminar el grupo "${t.title}" y todos sus marcadores?`)&&(await Ot(t.id),c===t.id&&(c=null),await C(),c?await f():r.innerHTML="")}),y.appendChild(o)}setTimeout(_e,50)}let je="";async function f(){if(!c)return;const e=await ue(c);r.innerHTML="";const o=(await w()).find(n=>n.id===c);if(o)if(r.classList.remove("layout-list"),o.layoutType==="dynamic"){const n=o.dynamicWidth||240,d=o.dynamicHeight||180;r.style.gridTemplateColumns=`repeat(auto-fill, minmax(${n}px, 1fr))`,r.style.setProperty("--dial-height",`${d}px`),r.style.setProperty("--dial-aspect-ratio","auto")}else if(o.layoutType==="list"){if(r.classList.add("layout-list"),o.listDirection==="horizontal"){const n=o.listWidth||240;r.style.gridTemplateColumns=`repeat(auto-fill, minmax(${n}px, 1fr))`,r.style.maxWidth="none"}else r.style.gridTemplateColumns="1fr",r.style.maxWidth=`${o.listWidth||800}px`;r.style.margin="0 auto",r.style.setProperty("--dial-height","auto"),r.style.setProperty("--dial-aspect-ratio","auto")}else{r.style.margin="0",r.style.maxWidth="none";const n=o.columns||4;r.style.gridTemplateColumns=`repeat(${n}, minmax(10px, 1fr))`;const d=o.gridAspectWidth||16,s=o.gridAspectHeight||12;r.style.setProperty("--dial-height","auto"),r.style.setProperty("--dial-aspect-ratio",`${d} / ${s}`)}if(e.forEach((n,d)=>{const s=document.createElement("div"),i=m.has(n.id);s.className=`dial-card glass-panel ${i?"is-share-selected":""}`,s.draggable=!G,s.dataset.id=n.id,s.dataset.index=d.toString(),s.addEventListener("click",async v=>{if(z)return;if(G){v.preventDefault(),v.stopPropagation(),m.has(n.id)?(m.delete(n.id),s.classList.remove("is-share-selected")):(m.add(n.id),s.classList.add("is-share-selected")),Se();return}if(v.target.closest(".dial-actions"))return;v.preventDefault();const x=(await w()).find(Ge=>Ge.id===n.groupId);x?.openInNewWindow?typeof chrome<"u"&&chrome.windows?chrome.windows.create({url:n.url}):window.open(n.url,"_blank","menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yes"):x?.openInNewTab||v.ctrlKey||v.metaKey||v.button===1?window.open(n.url,"_blank"):window.location.href=n.url});const p=je?`&t=${je}`:"",l=`https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=${encodeURIComponent(n.url)}&size=128${p}`,u=Vn(n.title,n.url),L=Gt[Rn(n.url)];s.innerHTML=`
      <div class="share-check-badge">
         <svg viewBox="0 0 24 24" fill="none" class="icon" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
      </div>
      <div class="dial-thumbnail">
        <div class="dial-logo-fallback" style="background: ${L}; position: absolute; inset:0; border-radius: 0; width: 100%; height: 100%;">
           ${u}
        </div>
        <img src="${l}" alt="${n.title}" class="dial-icon-img" style="position:relative; z-index:1; width: 64px; height: 64px; border-radius: 16px; object-fit: contain; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.3); background: white; padding: 4px;">
      </div>
      <div class="dial-footer">
        <h3 class="dial-title" title="${n.title}">${n.title}</h3>
        ${o?.isLocked?"":`
        <div class="dial-actions">
          <button class="dial-action-btn edit-btn" title="Editar">
             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          </button>
          <button class="dial-action-btn delete-btn" title="Eliminar">
             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
          </button>
        </div>`}
      </div>
    `;const h=s.querySelector(".dial-icon-img");h&&h.addEventListener("error",()=>{h.style.display="none"}),s.addEventListener("dragstart",v=>{if(o?.isLocked){v.preventDefault();return}V=d,v.dataTransfer&&(v.dataTransfer.effectAllowed="move"),s.style.opacity="0.5"}),s.addEventListener("dragover",v=>{v.preventDefault(),v.dataTransfer&&(v.dataTransfer.dropEffect="move")}),s.addEventListener("drop",async v=>{v.preventDefault(),v.stopPropagation();const Me=d;if(V!==null&&V!==Me&&c){const x=await ue(c),[Ge]=x.splice(V,1);x.splice(Me,0,Ge),x.forEach((se,Rt)=>se.order=Rt),await ut(x);for(const se of x)await mt(se.id,{order:se.order});await f()}}),s.addEventListener("dragend",()=>{s.style.opacity="1",V=null}),s.querySelector(".edit-btn")?.addEventListener("click",()=>Ke(n)),s.querySelector(".delete-btn")?.addEventListener("click",async()=>{confirm(`¬øEliminar "${n.title}"?`)&&(await Yt(n.id),await f())}),r.appendChild(s)}),!G&&!o?.isLocked){const n=document.createElement("div");n.className="dial-card add-dial-card",n.title="A√±adir Nuevo Marcador",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.cursor="pointer",n.style.background="rgba(255, 255, 255, 0.03)",n.style.border="2px dashed rgba(255, 255, 255, 0.2)",n.style.minHeight="140px",n.style.transition="all 0.3s ease",n.innerHTML=`
      <svg viewBox="0 0 24 24" fill="none" class="icon" stroke="currentColor" stroke-width="2" style="width: 48px; height: 48px; opacity: 0.5; stroke: white;">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    `,n.addEventListener("click",()=>{Ke()}),n.addEventListener("mouseenter",()=>{n.style.background="rgba(255, 255, 255, 0.08)",n.style.borderColor="rgba(255, 255, 255, 0.4)"}),n.addEventListener("mouseleave",()=>{n.style.background="rgba(255, 255, 255, 0.03)",n.style.borderColor="rgba(255, 255, 255, 0.2)"}),r.appendChild(n)}}async function Ke(e){if(!c){alert("Selecciona un grupo primero.");return}if((await w()).find(n=>n.id===c)?.isLocked){alert("Este grupo est√° bloqueado. Desbloqu√©alo para a√±adir o editar marcadores.");return}me.classList.remove("hidden"),e?(Q=e.id,tt.textContent="Editar Marcador",gt.value=e.title,pt.value=e.url):(Q=null,tt.textContent="A√±adir Marcador",Ze.reset())}function we(){me.classList.add("hidden"),Ze.reset(),Q=null}en.addEventListener("click",()=>Ke());tn.addEventListener("click",we);nn.addEventListener("click",we);me.addEventListener("click",e=>{e.target===me&&we()});Ze.addEventListener("submit",async e=>{if(e.preventDefault(),!c)return;const t=gt.value.trim();let o=pt.value.trim();!t||!o||(/^https?:\/\//i.test(o)||(o="https://"+o),Q?await mt(Q,{title:t,url:o}):await Kt({groupId:c,title:t,url:o}),we(),await f())});function Yn(e){J.classList.remove("hidden"),b=null,vt.textContent="A√±adir Grupo",Qe.reset()}function xe(){J.classList.add("hidden"),Qe.reset(),b=null}on.addEventListener("click",()=>Yn());an.addEventListener("click",xe);dn.addEventListener("click",xe);J.addEventListener("click",e=>{e.target===J&&xe()});Qe.addEventListener("submit",async e=>{e.preventDefault();const t=Pe.value.trim();t&&(b?await rt(b,{title:t}):c=(await Vt(t)).id,xe(),await C(),await f())});let a={};function g(){const e=document.getElementById("dial-grid");if(!e)return;if(e.classList.remove("layout-list"),a.layoutType==="dynamic"){const o=a.dynamicWidth||240,n=a.dynamicHeight||180;e.style.gridTemplateColumns=`repeat(auto-fill, minmax(${o}px, 1fr))`,e.style.margin="0",e.style.maxWidth="none",e.style.setProperty("--dial-height",`${n}px`),e.style.setProperty("--dial-aspect-ratio","auto")}else if(a.layoutType==="list"){if(e.classList.add("layout-list"),a.listDirection==="horizontal"){const o=a.listWidth||240;e.style.gridTemplateColumns=`repeat(auto-fill, minmax(${o}px, 1fr))`,e.style.maxWidth="none"}else e.style.gridTemplateColumns="1fr",e.style.maxWidth=`${a.listWidth||800}px`;e.style.margin="0 auto",e.style.setProperty("--dial-height","auto"),e.style.setProperty("--dial-aspect-ratio","auto")}else{e.style.margin="0",e.style.maxWidth="none";const o=a.columns||4;e.style.gridTemplateColumns=`repeat(${o}, minmax(10px, 1fr))`;const n=a.gridAspectWidth||16,d=a.gridAspectHeight||12;e.style.setProperty("--dial-height","auto"),e.style.setProperty("--dial-aspect-ratio",`${n} / ${d}`)}a.gapSize!==void 0?e.style.gap=`${a.gapSize}px`:a.layoutType==="list"&&a.listDirection==="vertical"?e.style.gap="8px":e.style.gap="15px",a.textColor?e.style.color=a.textColor:e.style.color="";const t=document.querySelector(`.group-tab[data-id="${b}"]`);if(t){let o=a.groupIcon?`<span style="margin-right: 6px; font-size: 1.1rem; line-height: 1;">${a.groupIcon}</span>`:"";a.isLocked&&(o+='<svg style="margin-right: 4px; width: 14px; height: 14px; opacity: 0.7;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>'),a.isDefault&&(o+='<svg style="margin-right: 4px; width: 14px; height: 14px; opacity: 0.5;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>');const n=t.querySelector(".group-icon-container");n&&(n.innerHTML=o);const d=t.querySelector(".group-title");d&&(d.textContent=(a.title||"").replace(/^[üìÅüìÇ]\s*/,"").trim()||a.title||"",d.style.color=a.textColor||"")}_n(a)}function _n(e){const t=e.bgType||"none";if(t==="none")document.body.style.background="";else if(t==="solid")document.body.style.background=e.bgColor1||"#28005f";else if(t==="gradient"){const o=e.bgGradientType==="linear"?"linear-gradient":"radial-gradient",n=e.bgGradientType==="linear"?"135deg":e.bgGradientType==="radial-circle"?"circle at center":"ellipse at center",d=e.bgColor1||"#3b82f6",s=e.bgColor2||"#0f172a";document.body.style.background=`${o}(${n}, ${d}, ${s})`}else document.body.style.background=""}function $t(e){$e&&($e.style.display=e==="solid"?"flex":"none",e==="solid"&&$e.classList.remove("hidden")),Ae&&(Ae.style.display=e==="gradient"?"flex":"none",e==="gradient"&&Ae.classList.remove("hidden"))}function At(e){b=e.id;const t=e.title.replace(/^[üìÅüìÇ]\s*/,"").trim()||e.title;if(sn.textContent=`Editar grupo: "${t}"`,ht.value=t,a={...e,title:t},ee.textContent=(a.columns||4).toString(),te.textContent=(a.rows||5).toString(),Ne&&(Ne.value=(a.dynamicWidth||240).toString()),Ue&&(Ue.value=(a.dynamicHeight||180).toString()),We&&(We.value=(a.listWidth||240).toString()),Y&&(Y.checked=a.gridFill!==!1),_&&(_.checked=a.gridCenterSlides||!1),Fe&&(Fe.value=(a.gridAspectWidth||16).toString()),ze&&(ze.value=(a.gridAspectHeight||12).toString()),a.layoutType==="dynamic"?ve&&(ve.checked=!0):a.layoutType==="list"?he&&(he.checked=!0):ye&&(ye.checked=!0),ie&&ie.length>0)if(ie.forEach(d=>d.classList.remove("active")),a.groupIcon){const d=document.querySelector(`.adv-icon-choice[data-icon="${a.groupIcon}"]`);d&&d.classList.add("active")}else ie[0].classList.add("active");T&&I&&W&&(a.textColor?(T.checked=!0,I.value=a.textColor,W.textContent=a.textColor.toUpperCase()):(T.checked=!1,I.value="#ffffff",W.textContent="#FFFFFF"));const o=a.bgType||"none",n=a.bgGradientType||"radial-ellipse";Lt.forEach(d=>{d.value===o&&(d.checked=!0)}),bt.forEach(d=>{d.value===n&&(d.checked=!0)}),P&&qe&&(P.value=a.bgColor1||"#28005f",qe.textContent=(a.bgColor1||"#28005f").toUpperCase()),N&&Re&&U&&Ve&&(N.value=a.bgColor1||"#3b82f6",Re.textContent=(a.bgColor1||"#3b82f6").toUpperCase(),U.value=a.bgColor2||"#0f172a",Ve.textContent=(a.bgColor2||"#0f172a").toUpperCase()),$t(o),D&&k&&ce&&(a.gapSize!==void 0?(D.checked=!0,k.value=a.gapSize.toString(),ce.textContent=a.gapSize+"px"):(D.checked=!1,k.value="20",ce.textContent="20px")),j&&(j.checked=a.openInNewWindow||!1),K&&(K.checked=a.openInNewTab||!1),X&&(X.checked=a.isDefault||!1),S&&(S.checked=a.isLocked||!1),F&&M&&(S.checked?(F.style.display="block",M.value=a.password||""):(F.style.display="none",M.value="")),pe.forEach(d=>d.classList.remove("active")),yt.forEach(d=>d.classList.add("hidden")),pe[0].classList.add("active"),document.getElementById("tab-general")?.classList.remove("hidden"),Ee=0,Le=0,fe&&(fe.style.transform="translate(0px, 0px)"),g(),ge.classList.remove("hidden")}nt&&nt.addEventListener("click",()=>{let e=parseInt(ee.textContent||"4");e=Math.min(12,e+1),ee.textContent=e.toString(),a.columns=e,g()});ot&&ot.addEventListener("click",()=>{let e=parseInt(ee.textContent||"4");e=Math.max(1,e-1),ee.textContent=e.toString(),a.columns=e,g()});at&&at.addEventListener("click",()=>{let e=parseInt(te.textContent||"5");e=Math.min(20,e+1),te.textContent=e.toString(),a.rows=e});dt&&dt.addEventListener("click",()=>{let e=parseInt(te.textContent||"5");e=Math.max(1,e-1),te.textContent=e.toString(),a.rows=e});const et=()=>{ve?.checked?a.layoutType="dynamic":he?.checked?a.layoutType="list":ye?.checked&&(a.layoutType="grid"),g()},Ht=()=>{ft?.checked?a.listDirection="horizontal":Et?.checked&&(a.listDirection="vertical"),g()};ve?.addEventListener("change",et);he?.addEventListener("change",et);ye?.addEventListener("change",et);ft?.addEventListener("change",Ht);Et?.addEventListener("change",Ht);const de=(e,t,o,n,d,s,i=10)=>{if(!e||!t||!o)return;const p=l=>{l=Math.max(d,Math.min(s,l)),e.value=l.toString(),a[n]=l,g()};t.addEventListener("click",l=>{l.preventDefault(),p(parseInt(e.value||"0")+i)}),o.addEventListener("click",l=>{l.preventDefault(),p(parseInt(e.value||"0")-i)}),e.addEventListener("input",()=>{let l=parseInt(e.value);isNaN(l)||(a[n]=l,g())})};de(Ne,un,mn,"dynamicWidth",50,1e3);de(Ue,gn,pn,"dynamicHeight",50,1e3);de(We,vn,hn,"listWidth",50,1e3);de(Fe,yn,fn,"gridAspectWidth",1,100,1);de(ze,En,Ln,"gridAspectHeight",1,100,1);Y&&Y.addEventListener("change",()=>{a.gridFill=Y.checked,g()});_&&_.addEventListener("change",()=>{a.gridCenterSlides=_.checked,g()});const He=document.getElementById("adv-icon-grid");He&&He.addEventListener("click",e=>{const t=e.target;if(t.classList.contains("adv-icon-choice")){He.querySelectorAll(".adv-icon-choice").forEach(d=>d.classList.remove("active")),t.classList.add("active");const n=t.getAttribute("data-icon");n&&n!=="‚úñ"?a.groupIcon=n:a.groupIcon=void 0,g()}});T&&T.addEventListener("change",()=>{T.checked?(a.textColor=I.value,W.textContent=I.value.toUpperCase()):(a.textColor=void 0,W.textContent="#FFFFFF"),g()});I&&I.addEventListener("input",()=>{W.textContent=I.value.toUpperCase(),T.checked&&(a.textColor=I.value,g())});Lt.forEach(e=>{e.addEventListener("change",()=>{e.checked&&(a.bgType=e.value,$t(e.value),g())})});bt.forEach(e=>{e.addEventListener("change",()=>{e.checked&&(a.bgGradientType=e.value,g())})});P&&P.addEventListener("input",()=>{qe.textContent=P.value.toUpperCase(),a.bgColor1=P.value,a.bgType==="solid"&&g()});N&&N.addEventListener("input",()=>{Re.textContent=N.value.toUpperCase(),a.bgColor1=N.value,a.bgType==="gradient"&&g()});U&&U.addEventListener("input",()=>{Ve.textContent=U.value.toUpperCase(),a.bgColor2=U.value,a.bgType==="gradient"&&g()});D&&D.addEventListener("change",()=>{D.checked?a.gapSize=parseInt(k.value,10):a.gapSize=void 0,g()});k&&k.addEventListener("input",()=>{ce.textContent=k.value+"px",D.checked&&(a.gapSize=parseInt(k.value,10),g())});j&&j.addEventListener("change",()=>{a.openInNewWindow=j.checked});K&&K.addEventListener("change",()=>{a.openInNewTab=K.checked});X&&X.addEventListener("change",()=>{a.isDefault=X.checked});S&&S.addEventListener("change",()=>{a.isLocked=S.checked,F&&(S.checked?F.style.display="block":(F.style.display="none",M.value="",a.password=void 0))});M&&M.addEventListener("input",()=>{a.password=M.value});function ke(){ge.classList.add("hidden"),b=null,w().then(e=>{const t=e.find(o=>o.id===c);t&&(a={...t},g())})}ln.addEventListener("click",ke);rn.addEventListener("click",ke);ge.addEventListener("click",e=>{e.target===ge&&ke()});pe.forEach(e=>{e.addEventListener("click",()=>{pe.forEach(o=>o.classList.remove("active")),yt.forEach(o=>o.classList.add("hidden")),e.classList.add("active");const t=e.getAttribute("data-tab");t&&document.getElementById(t)?.classList.remove("hidden")})});cn.addEventListener("click",async()=>{if(!b)return;const e=ht.value.trim();e&&(a.title=e,await rt(b,a),await C(),await f()),ke()});let z=!1;function Ce(){Ye.classList.toggle("hidden")}function Pt(){z?(document.body.classList.add("edit-mode"),O.textContent="‚úÖ Desactivar Modo Edici√≥n",O.style.background="#10b981"):(document.body.classList.remove("edit-mode"),O.textContent="üõ†Ô∏è Activar Modo Edici√≥n",O.style.background="")}chrome.storage.local.get(["isEditMode"],e=>{z=!!e.isEditMode,Pt()});O.addEventListener("click",()=>{z=!z,chrome.storage.local.set({isEditMode:z}),Pt()});Ct.addEventListener("click",e=>{e.stopPropagation(),E.classList.toggle("hidden")});document.addEventListener("click",e=>{const t=e.target;!E.contains(t)&&t!==Ct&&(E.classList.add("hidden"),document.getElementById("menu-update-thumbnails-container")?.classList.remove("active"),document.getElementById("menu-advanced-container")?.classList.remove("active"))});const Xe=document.getElementById("menu-update-thumbnails-container"),it=document.getElementById("menu-update-thumbnails"),oe=document.getElementById("menu-advanced-container"),lt=document.getElementById("menu-advanced");it&&Xe&&it.addEventListener("click",e=>{e.stopPropagation(),oe?.classList.remove("active"),Xe.classList.toggle("active")});lt&&oe&&lt.addEventListener("click",e=>{e.stopPropagation(),Xe?.classList.remove("active"),oe.classList.toggle("active")});const ct=document.getElementById("menu-help");ct&&ct.addEventListener("click",e=>{e.stopPropagation(),E.classList.add("hidden"),chrome.tabs.create({url:chrome.runtime.getURL("Help.md")})});document.getElementById("sub-update-group")?.addEventListener("click",e=>{e.stopPropagation(),E.classList.add("hidden"),document.getElementById("menu-update-thumbnails-container")?.classList.remove("active");const t=document.querySelectorAll(".dial-icon-img"),o=Date.now();t.forEach(n=>{const d=n.src.split("&t=")[0];n.src=`${d}&t=${o}`,n.style.display="block"})});document.getElementById("sub-update-missing")?.addEventListener("click",e=>{e.stopPropagation(),E.classList.add("hidden"),document.getElementById("menu-update-thumbnails-container")?.classList.remove("active");const t=document.querySelectorAll(".dial-icon-img"),o=Date.now();let n=0;t.forEach(d=>{if(d.style.display==="none"){const s=d.src.split("&t=")[0];d.src=`${s}&t=${o}`,d.style.display="block",n++}}),n===0&&alert("Todas las miniaturas de este grupo est√°n correctamente cargadas.")});document.getElementById("sub-update-all")?.addEventListener("click",async e=>{e.stopPropagation(),E.classList.add("hidden"),document.getElementById("menu-update-thumbnails-container")?.classList.remove("active"),je=Date.now().toString(),await f()});document.getElementById("sub-show-errors")?.addEventListener("click",e=>{e.stopPropagation(),E.classList.add("hidden"),oe?.classList.remove("active"),Kn()});document.getElementById("sub-show-stats")?.addEventListener("click",async e=>{e.stopPropagation(),E.classList.add("hidden"),oe?.classList.remove("active"),await jn()});async function jn(){const e=await w(),t=await $();Bn.textContent=e.length.toString(),In.textContent=t.length.toString();const o=e.length>0?(t.length/e.length).toFixed(1):"0.0";wn.textContent=o,be.classList.remove("hidden")}function Kn(){Be.classList.remove("hidden")}function Nt(){be.classList.add("hidden")}function Ut(){Be.classList.add("hidden")}bn.addEventListener("click",Nt);be.addEventListener("click",e=>{e.target===be&&Nt()});xn.addEventListener("click",Ut);Be.addEventListener("click",e=>{e.target===Be&&Ut()});Cn.addEventListener("click",()=>{kn.value="",alert("Se ha vaciado el Log de incidentes de esta sesi√≥n.")});function Wt(){q.classList.remove("hidden"),Oe.value="",re.innerHTML="",Oe.focus()}function ae(){q.classList.add("hidden")}document.getElementById("menu-search-dial")?.addEventListener("click",()=>{E.classList.add("hidden"),Wt()});Sn.addEventListener("click",ae);q.addEventListener("click",e=>{e.target===q&&ae()});document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.shiftKey&&e.code==="KeyF"&&(e.preventDefault(),q.classList.contains("hidden")?Wt():ae()),e.key==="Escape"&&(q.classList.contains("hidden")||ae())});Oe.addEventListener("input",async e=>{const t=e.target.value.toLowerCase().trim();if(re.innerHTML="",t.length<1)return;const n=(await $()).filter(d=>d.title.toLowerCase().includes(t)||d.url.toLowerCase().includes(t)).slice(0,15);if(n.length===0){re.innerHTML='<div style="padding: 1rem; color: var(--text-secondary); text-align: center;">No se encontraron resultados.</div>';return}n.forEach(d=>{const s=document.createElement("a");s.href=d.url,s.className="search-result-item",s.addEventListener("click",()=>ae());const i=document.createElement("img");i.className="search-result-favicon",i.src=`https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=${encodeURIComponent(d.url)}&size=32`,i.onerror=()=>{i.style.display="none"};const p=document.createElement("div");p.className="search-result-info";const l=document.createElement("span");l.className="search-result-title",l.textContent=d.title;const u=document.createElement("span");u.className="search-result-url",u.textContent=d.url,p.appendChild(l),p.appendChild(u),s.appendChild(i),s.appendChild(p),re.appendChild(s)})});document.getElementById("menu-options")?.addEventListener("click",()=>{E.classList.add("hidden"),Ce()});document.getElementById("menu-select-dials")?.addEventListener("click",()=>{E.classList.add("hidden"),alert("Funci√≥n 'Seleccionar diapositivas' en desarrollo...")});function Se(){const e=m.size;Dn.textContent=`Seleccionado: ${e} diapositivas`,Hn.textContent=`Seleccionado: ${e}`,Pn.textContent=`${e} diapositivas preparadas`}async function Xn(){if(m.size===0){le.innerHTML='<div style="color:var(--text-secondary); text-align:center;">No has seleccionado ninguna diapositiva.</div>';return}const e=await $(),t=await w(),o=e.filter(d=>m.has(d.id)),n={};o.forEach(d=>{n[d.groupId]||(n[d.groupId]=[]),n[d.groupId].push(d)}),le.innerHTML="";for(const[d,s]of Object.entries(n)){const i=t.find(u=>u.id===d),p=i?i.title:"Grupo Desconocido",l=document.createElement("div");l.className="share-group-header",l.innerHTML=`
         <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
         ${p}:
      `,le.appendChild(l),s.forEach(u=>{const L=document.createElement("div");L.className="share-item-row";const h=`https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=${encodeURIComponent(u.url)}&size=32`;L.innerHTML=`
            <img src="${h}" class="share-item-favicon" onerror="this.style.display='none'">
            <div class="share-item-title">${u.title} - <span style="color:var(--text-secondary)">${u.url}</span></div>
         `,le.appendChild(L)})}}function Zn(){G=!0,m.clear(),document.body.classList.add("share-mode-active"),R.classList.remove("hidden"),setTimeout(()=>R.classList.add("active"),10),Se(),C(),f()}function Te(){G=!1,m.clear(),document.body.classList.remove("share-mode-active"),R.classList.remove("active"),setTimeout(()=>R.classList.add("hidden"),300),ne.classList.add("hidden"),C(),f()}function Qn(){R.classList.remove("active"),ne.classList.remove("hidden"),Xn()}function Ft(){ne.classList.add("hidden"),R.classList.add("active")}document.getElementById("menu-edit-group")?.addEventListener("click",async e=>{e.stopPropagation(),E.classList.add("hidden");const o=(await w()).find(n=>n.id===c);o?At(o):alert("Prueba seleccionando un grupo v√°lido en las pesta√±as superiores primero.")});document.getElementById("menu-share-dials")?.addEventListener("click",()=>{E.classList.add("hidden"),Zn()});Tn.addEventListener("click",async()=>{const e=await $();e.length>0&&m.size===e.length?m.clear():e.forEach(o=>m.add(o.id)),Se(),C(),f()});Mn.addEventListener("click",Te);Gn.addEventListener("click",Qn);$n.addEventListener("click",Te);An.addEventListener("click",Ft);ne.addEventListener("click",e=>{e.target===ne&&Ft()});Nn.addEventListener("click",async()=>{if(m.size===0){alert("No has seleccionado ning√∫n marcador.");return}const t=(await $()).filter(d=>m.has(d.id)),n=`${kt.value||"Mis Marcadores"}:

`+t.map(d=>`${d.title} - ${d.url}`).join(`
`);try{await navigator.clipboard.writeText(n),alert("¬°Marcadores copiados al portapapeles!"),Te()}catch(d){console.error("Error al copiar: ",d),alert("Error al copiar al portapapeles. Revisa los permisos de tu navegador.")}});Un.addEventListener("click",async()=>{if(m.size===0){alert("No has seleccionado ning√∫n marcador.");return}const t=(await $()).filter(l=>m.has(l.id)),o=kt.value||"Compartidos";let n=`<!DOCTYPE NETSCAPE-Bookmark-file-1>
<!-- This is an automatically generated file.
     It will be read and overwritten.
     DO NOT EDIT! -->
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>Bookmarks</TITLE>
<H1>Bookmarks</H1>
<DL><p>
    <DT><H3 ADD_DATE="${Math.floor(Date.now()/1e3)}">${o}</H3>
    <DL><p>
`;t.forEach(l=>{n+=`        <DT><A HREF="${l.url}" ADD_DATE="${Math.floor(Date.now()/1e3)}">${l.title}</A>
`}),n+=`    </DL><p>
</DL><p>`;const d=new Blob([n],{type:"text/html"}),s=URL.createObjectURL(d),i=document.createElement("a");i.href=s;const p=o.replace(/[^a-z0-9]/gi,"_").toLowerCase();i.download=`bookmarks_${p}.html`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),Te()});Wn.addEventListener("click",Ce);Ye.addEventListener("click",e=>{e.target===Ye&&Ce()});async function zt(){const e=St,t=Dt;e.textContent="Importando...",t.textContent="Importando...";try{const o=await _t();alert(`¬°Importaci√≥n completada! Se han importado ${o} marcadores nativos.`),Ie.classList.add("hidden"),Ce(),window.location.reload()}catch(o){console.error(o),alert("Error al importar marcadores nativos."),e.textContent="ü¶ä Importar del Navegador",t.textContent="ü¶ä Importar Marcadores del Navegador"}}async function qt(e){const t=e.target;if(!t.files||t.files.length===0)return;const o=t.files[0],n=new FileReader;n.onload=async d=>{const s=d.target?.result;try{const i=await jt(s);alert(`¬°√âxito! Se han importado ${i} marcadores correctamente.`),Ie.classList.add("hidden"),window.location.reload()}catch(i){console.error(i),alert("Ocurri√≥ un error al procesar el archivo HTML.")}},n.readAsText(o)}St.addEventListener("click",zt);Dt.addEventListener("click",zt);Fn.addEventListener("click",()=>Tt.click());Tt.addEventListener("change",qt);zn.addEventListener("click",()=>Mt.click());Mt.addEventListener("change",qt);qn.addEventListener("click",()=>{Ie.classList.add("hidden")});if(A&&H&&y){const e=()=>y.clientHeight>0?y.clientHeight:38;A.addEventListener("click",()=>{y.scrollBy({top:-e(),behavior:"smooth"})}),H.addEventListener("click",()=>{y.scrollBy({top:e(),behavior:"smooth"})}),y.addEventListener("scroll",_e),window.addEventListener("resize",_e),y.addEventListener("wheel",t=>{if(t.deltaY!==0){t.preventDefault();const o=t.deltaY>0?1:-1;y.scrollBy({top:e()*o,behavior:"auto"})}})}document.addEventListener("contextmenu",e=>{const t=e.target;if((r.contains(t)||t===r)&&c){e.preventDefault(),B.style.display="block";const n=B.getBoundingClientRect(),d=n.width||240,s=n.height||180;let i=e.clientX,p=e.clientY;i+d>window.innerWidth&&(i=window.innerWidth-d),p+s>window.innerHeight&&(p=window.innerHeight-s),B.style.left=`${i}px`,B.style.top=`${p}px`}else B.style.display="none"});document.addEventListener("click",()=>{B&&B.style.display==="block"&&(B.style.display="none")});async function De(e){if(!c)return;const t=await $(),o=t.filter(s=>s.groupId===c);o.sort(e),o.forEach((s,i)=>{s.order=i});const n=new Set(o.map(s=>s.id)),d=t.filter(s=>!n.has(s.id)).concat(o);await ut(d),B.style.display="none",await f()}Xt?.addEventListener("click",()=>{De((e,t)=>e.title.toLowerCase().localeCompare(t.title.toLowerCase()))});Zt?.addEventListener("click",()=>{De((e,t)=>t.title.toLowerCase().localeCompare(e.title.toLowerCase()))});Qt?.addEventListener("click",()=>{De((e,t)=>parseInt(e.id)-parseInt(t.id))});Jt?.addEventListener("click",()=>{De((e,t)=>parseInt(t.id)-parseInt(e.id))});On();
